#!/bin/bash

# ==============================================================================
# kubectl-searchlogs
# A kubectl plugin to grep logs across all pods in a namespace, sorted by time.
#
# Options:
#   -n <namespace>   : The namespace to search (Optional, defaults to current context).
#   -t <time-window> : How far back to search (Optional, defaults to 30m).
#
# Arguments:
#   <SEARCH_STRING>  : The string/regex to find in the logs.
# ==============================================================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Check for kubectl dependency
if ! command -v kubectl &> /dev/null; then
    echo -e "${RED}Error: kubectl is not installed or not in PATH.${NC}"
    exit 1
fi

print_usage() {
    echo "Usage: kubectl searchlogs [-n <NAMESPACE>] [-t <TIME_WINDOW>] <SEARCH_STRING>"
    echo ""
    echo "Options:"
    echo "  -n    Target namespace (Default: current context namespace)."
    echo "  -t    Time window (Default: 30m). Formats: s (seconds), m (minutes), h (hours)"
    echo "        Example: -t 10m (last 10 minutes), -t 4h (last 4 hours)"
    echo "  -h    Show this help message."
    echo ""
    echo "Example:"
    echo "  kubectl searchlogs -n payment-service -t 1h 'Transaction Failed'"
    echo "  kubectl searchlogs 'Error' (uses default namespace and 30m.)"
}

NAMESPACE=""
TIME_WINDOW="30m"

while getopts "n:t:h" opt; do
    case ${opt} in
        n) NAMESPACE="$OPTARG" ;;
        t) TIME_WINDOW="$OPTARG" ;;
        h) print_usage; exit 0 ;;
        *) print_usage; exit 1 ;;
    esac
done
shift $((OPTIND -1))

SEARCH_STRING="$1"

# Determine namespace if not provided
if [[ -z "$NAMESPACE" ]]; then
    # Try to get the current namespace from kubectl config
    NAMESPACE=$(kubectl config view --minify --output 'jsonpath={..namespace}' 2>/dev/null)

    # If still empty (e.g., no context set or explicit default), default to 'default'
    if [[ -z "$NAMESPACE" ]]; then
        NAMESPACE="default"
    fi
    echo -e "${YELLOW}Using namespace: ${NAMESPACE}${NC}" >&2
fi

if [[ -z "$SEARCH_STRING" ]]; then
    echo -e "${RED}Error: Search string is missing.${NC}"
    print_usage
    exit 1
fi

# Validate time format (simple check if it ends in s, m, or h)
if ! [[ "$TIME_WINDOW" =~ ^[0-9]+[smh]$ ]]; then
    echo -e "${RED}Error: Invalid time format '$TIME_WINDOW'. Use <number><unit> (e.g., 30s, 5m, 1h).${NC}"
    exit 1
fi

# Check if namespace exists
if ! kubectl get namespace "$NAMESPACE" &> /dev/null; then
    echo -e "${RED}Error: Namespace '$NAMESPACE' not found.${NC}"
    exit 1
fi

# Fetch list of pods
PODS=$(kubectl get pods -n "$NAMESPACE" --no-headers -o custom-columns=":metadata.name")

if [ -z "$PODS" ]; then
    echo -e "${YELLOW}No pods found in namespace '$NAMESPACE'.${NC}"
    exit 0
fi

export NAMESPACE
export TIME_WINDOW
# Export colors for subshell
# export C_CYAN=$(printf "${CYAN}")
# export C_GREEN=$(printf "${GREEN}")
# export C_NC=$(printf "${NC}")

echo "$PODS" | \
xargs -P 4 -I {} sh -c '
    TAB="$(printf "\t")"

    stdbuf -oL kubectl logs -n "$NAMESPACE" "{}" --all-containers --since="$TIME_WINDOW" --timestamps 2>/dev/null | \
    stdbuf -oL awk -v pod="{}" '\''
    {
        # 1. Capture Timestamp (Field 1)
        ts = $1

        # 2. Capture the Message (Everything after the first space)
        # We use index/substr to preserve exact original spacing
        first_space = index($0, " ")
        if (first_space == 0) { next } # Skip empty/malformed lines
        msg = substr($0, first_space + 1)

        # 3. SANITIZE: Remove Carriage Returns (\r)
        # This fixes the "2026-01-07 02:42:5o1" corruption issue
        gsub(/\r/, "", msg)

        # 4. Extract clean Date and Time
        d = substr(ts, 1, 10)
        t = substr(ts, 12, 8)

        # 5. Handle Double Timestamps (e.g. "2026-01-06T..." inside the message)
        if (msg ~ /^[0-9]{4}-[0-9]{2}-[0-9]{2}T/) {
            sub(/^[^ ]+[ ]+/, "", msg)
        }

        # 6. Print with Tabs ONLY between columns
        # Format: DATE TIME <TAB> [POD] <TAB> MSG
        printf "%s %s\t[%s]\t%s\n", d, t, pod, msg
    }
    '\''
' | \
grep --line-buffered --color=always "$SEARCH_STRING" | \
sort
